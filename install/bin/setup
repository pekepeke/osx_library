#!/bin/bash

usage() {
  prg_name=`basename $0`
  cat <<EOM
  Usage: $prg_name [-h]
EOM
  exit 1
}

has_gem() {
  gem list | grep $1 >/dev/null 2>&1
  return $?
}

main() {
  cd $(dirname $0)/..

  if ! has_gem bundler ; then
    echo "*** install bundler"
    gem install bundler
  fi
  if [ ! -e vendor/bundle ]; then
    echo "*** exec bundle install"
    bundle install --path vendor/bundle
    echo "*** install chef cookbooks"
    bundle exec librarian-chef install
  fi
  echo "*** apply chef recipes"
  bundle exec chef-solo -c config/solo.rb
}

OPTIND_OLD=$OPTIND
OPTIND=1
while getopts "hvs:" opt; do
  case $opt in
    h)
      usage ;;
    v) ;;
    s)
      #$OPTARG
      ;;
  esac
done
shift `expr $OPTIND - 1`
OPTIND=$OPTIND_OLD
if [ $OPT_ERROR ]; then
  usage
fi

main "$@"

